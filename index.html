<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>QizzTris</title>
<style>
  :root { --bg:#0f1220; --fg:#e8ecf1; --panel:#121737; --line:#2a3361; --ok:#3ad29f; --accent:#6dd5ed; --accent2:#a17fe0; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
  header{padding:10px 14px;background:linear-gradient(to right,#151a30,#12162a);border-bottom:1px solid #22284a}
  footer{padding:10px 14px;background:linear-gradient(to right,#151a30,#12162a);border-top:1px solid #22284a;border-bottom:none}
  .title{font-weight:700;letter-spacing:.4px}
  .game{display:grid;grid-template-columns:1fr auto;gap:12px;padding:12px}
  .board-wrap{position:relative;margin:0 auto}
  canvas{background: radial-gradient(circle at 50% 0%, #101735, #0e1329 60%);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.35);display:block}
  .hud{display:grid;gap:8px;align-content:start;min-width:180px}
  .card{background:#131939;border:1px solid #262c54;border-radius:12px;padding:10px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .pill{padding:4px 10px;border-radius:999px;background:#101633;border:1px solid #232a52;font-size:14px}

  /* Start modal */
  #start{position:fixed;inset:0;display:grid;place-items:center;background:rgba(6,9,20,0.96);z-index:30}
  #start .panel{width:min(520px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .field{margin-bottom:12px}.field label{display:block;font-size:18px;opacity:.85;margin-bottom:6px}
  .field select,#start .field input[type='number']{

  width: 100%;
  box-sizing: border-box;   /* ← include padding + border in 100% */
  min-width: 0;             /* ← allow it to shrink inside grids/flex */
  display: block;           /* ← avoid inline sizing quirks */

  background: #0e1430;
  color: var(--fg);
  border: 1px solid #27305e;
  border-radius: 10px;
  padding: 10px;
  outline: none;
}

/* Optional: remove spinners for tighter fit */
#start .field input[type='number']{
  appearance: textfield;
}
#start .field input[type='number']::-webkit-outer-spin-button,
#start .field input[type='number']::-webkit-inner-spin-button{
  -webkit-appearance: none;
  margin: 0;
}

/* If the rounded panel still clips: */
#start .panel { overflow: visible; }
.button{
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #07131a;
  font-weight: 700;
  padding: 5px 7px;
  border-radius: 12px;
  border: none;
  width: 100%;
  box-shadow: 0 8px 20px rgba(109,213,237,.25);
  cursor: pointer;
}
.button:hover{ filter: brightness(1.08); }
.button:active{ transform: translateY(1px); }

/* when there isn't space below, open upward */
.select-list.drop-up {
  top: auto;
  bottom: calc(100% + 6px);
}

  /* Toast */
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:10px;width:min(680px,94vw);z-index:40;display:none}
  #toast .toast-body{background:#0f1636;border:1px solid var(--line);border-radius:14px;box-shadow:0 14px 40px rgba(0,0,0,.5);padding:12px}
  #toast.min{width:300px;left:auto;right:10px;transform:none;bottom:10px}
  .toast-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .count{font-variant-numeric:tabular-nums;background:#0b1233;padding:4px 8px;border-radius:8px;border:1px solid #223066}
  .stem{font-size:16px;line-height:1.3;margin-bottom:8px}
  .answers{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .answers button{background:#121b45;border:1px solid #2a356e;color:var(--fg);padding:10px;border-radius:10px}
  .answers button:active{transform:translateY(1px)}
  .numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
  .numpad button{background:#121b45;border:1px solid #2a356e;color:var(--fg);padding:12px;border-radius:10px;font-weight:700}
  .sol{display:flex;gap:6px;margin:8px 0}
  .sol input{flex:1;background:#0c1435;color:var(--fg);border:1px solid #273268;border-radius:10px;padding:10px;font-size:18px;text-align:center}
  .sol button{background:var(--ok);color:#072018;border:none;border-radius:10px;padding:10px 12px;font-weight:700}

	
#start {  display: none !important; /* Ensure it can't override */ }

  /* Bar highlight */
  .bar-highlight{position:absolute;left:0;right:0;height:0;pointer-events:none}

  /* Footer controls row (no auto-centering; JS will align to canvas) */
  footer .controls{display:flex;gap:8px;justify-content:center}
  /* Control button colors */
#left {
  background-color: #64b5f6; /* blue */
  color: white;
}
#right {
  background-color: #64b5f6; /* blue */
  color: white;
  margin-right: 20px; /* extra space before Drop */
}
#rotate {
  background-color: #fdd835; /* yellow */
  color: black; /* better contrast with yellow */
}
#drop {
  background-color: #e53935; /* red */
  color: white;
}


/* Hover/active feedback */
footer .controls button:hover {
  filter: brightness(1.2);
}
footer .controls button:active {
  filter: brightness(0.9);
}


  /* File-picker overlay (fallback) */
  #picker { position: fixed; inset: 0; background: rgba(0,0,0,.75); display:none; place-items:center; z-index: 50; }
  #picker .box { background:#0f1636; border:1px solid var(--line); border-radius: 14px; padding: 16px; width: min(520px,92vw); }
  #picker h3 { margin: 0 0 8px; }

  @media (max-width:860px){.game{grid-template-columns:1fr}#toast.min{right:6px}}
  
  /* Hide the native select but keep it in the layout for forms/JS */
.select-hidden {
  position: absolute !important;
  opacity: 0 !important;
  pointer-events: none !important;
  width: 0 !important;
  height: 0 !important;
}

/* Wrapper matches your Start panel input look */
.select-wrap {
  position: relative;
}

.select-btn {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  background: #0e1430;         /* same as your inputs */
  color: var(--fg);
  border: 1px solid #27305e;
  border-radius: 12px;
  padding: 12px 14px;
  cursor: pointer;
  user-select: none;
}

.select-btn:focus-visible {
  outline: 2px solid #6aa7ff;
  outline-offset: 2px;
}

.select-caret {
  flex: 0 0 auto;
  width: 0; height: 0;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 7px solid #9fb3ff; /* subtle chevron */
}

/* Dropdown list panel (matches toast/panel tones) */
.select-list {
  position: absolute;
  left: 0; right: 0; top: calc(100% + 6px);
  background: #0f1636;          /* inner panel tone */
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 6px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45);
  max-height: 260px;
  overflow: auto;
  z-index: 70;
  display: none;
}

.select-list.open { display: block; }

/* Option rows styled like your pills */
.select-option {
  padding: 10px 12px;
  border-radius: 10px;
  line-height: 1.2;
  cursor: pointer;
}

.select-option[aria-selected="true"] {
  background: #131c42;
  border: 1px solid #27305e;
}

.select-option:hover,
.select-option:focus {
  background: #19224b;
}

.select-noresults {
  padding: 10px 12px;
  opacity: 0.7;
}

/* Optional tiny search inside the dropdown (comment out if not wanted) */
.select-search {
  width: 100%;
  background: #0e1430;
  color: var(--fg);
  border: 1px solid #27305e;
  border-radius: 10px;
  padding: 10px;
  margin: 4px 4px 8px;
}

</style>
<style id="mobile-hud-css">
@media (max-width: 860px) {
  /* hide the right-column HUD on mobile */
  .hud { display: none; }

  /* bigger, thumb-friendly buttons */
  footer .controls { justify-content: center; gap: 12px; }
  footer .controls button {
    min-width: 64px;
    padding: 14px 18px;
    font-size: 20px;
    border-radius: 14px;
  }

  /* compact HUD under the controls */
  .mobile-hud {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-top: 10px;
  }
  .mobile-hud .stat {
    background: #131939;
    border: 1px solid #262c54;
    border-radius: 12px;
    padding: 10px;
    text-align: center;
  }
  .mobile-hud .stat span { display:block; opacity:.8; font-size:12px; margin-bottom:4px; }
}
/* Leaderboard overlay (match Start / Toast aesthetic) */
#leaderboard {
  position: fixed; inset: 0; display: none; place-items: center;
  background: rgba(6,9,20,0.96); z-index: 60;
}
#leaderboard .panel {
  width: min(520px, 92vw);
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: 16px;
  padding: 16px;
}
#leaderboard input {
  width: 100%;
  background: #0e1430;
  color: var(--fg);
  border: 1px solid #27305e;
  border-radius: 10px;
  padding: 10px;
  outline: none;
}
#leaderboard tbody tr:nth-child(odd){
  background:#0f1636;
}
#leaderboard td {
  padding: 6px 8px;
}
.opening-screen {
  position: fixed;
  inset: 0;
  background: #0b0d20;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 999999;
  overflow: hidden; /* Keep content inside screen */
  text-align: center;
}

.opening-screen .logo {
  max-width: 80%;
  height: auto;
  margin-bottom: 2rem; /* Space before button */
}

.opening-screen button {
  padding: 0.7rem 2rem;
  border: none;
  border-radius: 12px;
  background: linear-gradient(to right, #6dd5ed, #a4b0ff);
  color: #fff;
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
	display: inline-block; /* Ensure not hidden */
}

</style>
</head>
<body>
	<div id="openingScreen" class="opening-screen">
  <img src="assets/splash.png" alt="QuizTris Logo" class="logo">
  <button id="enterBtn">Enter</button>
</div>

<div class="wrap">
 <header>
  <div class="row" style="display:grid; grid-template-columns: 1fr auto 1fr; align-items:center;">
    <div class="title" style="justify-self:start;">QuizTris</div>
    <button id="pauseBtn" style="padding:6px 12px; border-radius:8px; border:none; background:#ff9800; color:#000; font-weight:bold; cursor:pointer;">
      Pause</button>
    <div class="pill" id="status" style="justify-self:end;">Paused</div>
  </div>
</header>



  <main class="game">
    <div class="board-wrap">
      <canvas id="board" width="320" height="640"></canvas>
      <div id="barHighlights"></div>
    </div>
    <aside class="hud">
      <div class="card"><div class="row"><div>Score</div><strong id="score">0</strong></div></div>
      <div class="card"><div class="row"><div>Level</div><strong id="level">1</strong></div></div>
      <div class="card"><div class="row"><div>Lines</div><strong id="lines">0</strong></div></div>
      <div class="card"><div class="row"><div>Theme</div><strong id="themeName">—</strong></div></div>
    </aside>
  </main>

  <footer>
    <div class="controls">
      <button id="left">◀︎</button>
      <button id="rotate">⟳</button>
      <button id="right">▶︎</button>
      <button id="drop">⬇︎</button>
    </div>
    <div class="mobile-hud">
  <div class="stat"><span>Score</span><strong id="scoreM">0</strong></div>
  <div class="stat"><span>Level</span><strong id="levelM">1</strong></div>
  <div class="stat"><span>Lines</span><strong id="linesM">0</strong></div>
  <div class="stat"><span>Theme</span><strong id="themeNameM">—</strong></div>
</div>
  </footer>
</div>

<!-- Start Panel -->
<div id="start">
  <div class="panel">
    <h2>Start</h2>
    <div class="field">
      <label>Theme</label>
      <select id="theme">
      <option value="trivia">General Trivia</option>
<option value="geography">Geography</option>
<option value="history">History</option>
<option value="math">Math Trainer</option>
<option value="science">Science</option>
<option value="weird">Weird</option>

      </select>
	  <label for="language">Language</label>
<select id="language">
  <option value="en" selected>English</option>
  <option value="fr">Français</option>
</select>
    </div>
    <div class="field">
      <label>Quiz Timer</label>
      <input id="timerSec" type="number" min="3" max="20" step="1" value="7" />
    </div>
    <div class="field">
      <label>Board size</label>
      <select id="boardSize">
        <option value="10x20">10 × 20 (classic)</option>
        <option value="8x16">8 × 16</option>
        <option value="12x24">12 × 24</option>
      </select>
    </div>
    <button class="button" id="go">Play</button>
  </div>
</div>

<!-- Toast / Quiz -->
<div id="toast">
  <div class="toast-body">
    <div class="toast-head">
      <strong id="toastTitle">Question</strong>
      <span style="margin-left:auto"></span>
      <span class="count" id="countdown">00</span>
      <button id="minBtn" title="Minimize" style="background:#0e1430;border:1px solid #263163;color:var(--fg);border-radius:8px;padding:6px 8px;margin-left:8px">▁</button>
      <button id="closeBtn" title="Close" style="background:#0e1430;border:1px solid #263163;color:var(--fg);border-radius:8px;padding:6px 8px">✕</button>
    </div>
    <div class="stem" id="stem">—</div>
    <div id="ui-mc" class="answers" style="display:none"></div>
    <div id="ui-num" style="display:none">
      <div class="sol">
  <input id="solution" placeholder="Answer" readonly />
  <button id="submitNum">Submit</button>
</div>

      <div class="numpad" id="numpad"></div>
    </div>
  </div>
</div>
<!-- Leaderboard Modal -->
<div id="leaderboard" style="display:none">
  <div class="panel">
    <h2 style="margin-top:0">Leaderboard</h2>

    <div class="field">
      <label for="playerName">Your name</label>
      <input id="playerName" placeholder="Enter name" maxlength="20" />
    </div>

    <div class="field">
      <div id="finalStats" class="pill">Score 0 • Level 1 • Lines 0</div>
    </div>

    <div class="field" style="max-height:40vh; overflow:auto;">
      <table id="lbTable" style="width:100%; border-collapse:collapse">
        <thead>
          <tr>
            <th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--line)">#</th>
            <th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--line)">Name</th>
			<th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--line)">Theme</th>
      <th style="text-align:right; padding:6px 8px; border-bottom:1px solid var(--line)">Accuracy</th>
            <th style="text-align:right; padding:6px 8px; border-bottom:1px solid var(--line)">Score</th>
            <th style="text-align:right; padding:6px 8px; border-bottom:1px solid var(--line)">Lvl</th>
            <th style="text-align:right; padding:6px 8px; border-bottom:1px solid var(--line)">Lines</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

 <div class="row" style="gap:8px; margin-bottom:30px">
  <button class="button" id="saveScore">Save score</button>
</div>
<div class="row" style="gap:8px">
  <button class="button" id="playAgain">Play again</button>
  <button class="button" id="clearLB">Clear board</button>
  <button class="button" id="closeLB">Close</button>
</div>
  </div>
</div>

<!-- Embedded Trivia (fallback deck; you can expand this) -->
<script id="embedded-trivia" type="application/json">
[
  {"type":"mcq","stem":"Capital of France?","options":["Paris","Lyon","Marseille"],"correctIndex":0},
  {"type":"mcq","stem":"Largest planet in the Solar System?","options":["Jupiter","Saturn","Neptune"],"correctIndex":0},
  {"type":"mcq","stem":"H2O is…","options":["Water","Hydrogen","Oxygen"],"correctIndex":0},
  {"type":"mcq","stem":"Author of '1984'?","options":["George Orwell","Aldous Huxley","Ray Bradbury"],"correctIndex":0},
  {"type":"mcq","stem":"The Mona Lisa was painted by…","options":["Leonardo da Vinci","Michelangelo","Raphael","Titian"],"correctIndex":0},
  {"type":"mcq","stem":"Fastest land animal?","options":["Cheetah","Leopard","Pronghorn"],"correctIndex":0},
  {"type":"mcq","stem":"'I'll be back' is from…","options":["The Terminator","Predator","Commando"],"correctIndex":0},
  {"type":"mcq","stem":"Great Barrier Reef lies off…","options":["Australia","Indonesia","Fiji"],"correctIndex":0},
  {"type":"mcq","stem":"'The Matrix' pill Neo takes","options":["Red","Blue"],"correctIndex":0}
]
</script>

<!-- File-picker fallback overlay -->
<div id="picker">
  <div class="box">
    <h3>Load trivia.json</h3>
    <p>Pick a <code>trivia.json</code> from your computer (works even with <code>file://</code>).</p>
    <input type="file" id="fileInput" accept="application/json,.json" />
  </div>
</div>

<script>
/* ===== Utilities ===== */
const $ = s => document.querySelector(s);


function setHUDValue(idBase, value){
  const a = document.getElementById(idBase);
  if (a) a.textContent = value;
  const b = document.getElementById(idBase + 'M');
  if (b) b.textContent = value;
}
const rand = n => Math.floor(Math.random()*n);
const shuffle = arr => { for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };

document.getElementById('enterBtn').addEventListener('click', () => {
  document.getElementById('openingScreen').style.display = 'none';
  document.getElementById('start').style.display = 'grid'; // or whatever shows your start toast
});

/* ===== Game State ===== */
const canvas = $('#board');
const ctx = canvas.getContext('2d');
let COLS=10, ROWS=20, CELL=32;
let grid, active, nextTick=0, dropInterval=800, paused=true, gameOver=false;
let score=0, level=1, lines=0;
let quizCorrect = 0;
let quizAttempted = 0;
let timerPauseSeconds=5;
let theme='math';
let currentLang = 'en';
const i18n = {
  en: {
    quizTitle: 'Pick the Right Answer',
    mathTitle: 'Solve to Clear',
    statusPlaying: 'Playing',
    statusPaused: 'Paused',
  },
  fr: {
    quizTitle: 'Choisis la bonne réponse',
    mathTitle: 'Résous pour effacer',
    statusPlaying: 'En jeu',
    statusPaused: 'En pause',
  }
};
function t(key){
  const pack = i18n[currentLang] || i18n.en;
  return (pack && pack[key]) || i18n.en[key] || key;
}

const colors={ I:'#68e1fd', J:'#7aa2ff', L:'#ffb86c', O:'#ffdf6d', S:'#6ef7b4', T:'#d98bff', Z:'#ff7a9a', BAR:'#6ef7b480' };
const SHAPES={
  I:[[1,1,1,1]], J:[[1,0,0],[1,1,1]], L:[[0,0,1],[1,1,1]], O:[[1,1],[1,1]],
  S:[[0,1,1],[1,1,0]], T:[[0,1,0],[1,1,1]], Z:[[1,1,0],[0,1,1]]
};


const textures = {}; // filled by preloadTextures()

function preloadTextures(){
  const names = ['I','J','L','O','S','T','Z','BAR'];
  const loads = names.map(name => new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=>{ textures[name] = img; resolve(); };
    img.onerror = reject;
    img.src = `assets/textures/${name}.jpg`;
  }));
  return Promise.all(loads);
}

const PIECES = Object.keys(SHAPES);
function updateSpeed(){
  // Linear ramp: 800ms at L1 → faster each level, floored at 120ms
  dropInterval = Math.max(120, 630 - (level - 1) * 60);
  // If you prefer exponential instead, use:
  // dropInterval = Math.max(100, Math.round(800 * Math.pow(0.92, level - 1)));
}
function resizeBoard(){
  CELL=Math.floor(Math.min(window.innerWidth*0.9/COLS,(window.innerHeight*0.72)/ROWS));
  canvas.width=COLS*CELL;
  canvas.height=ROWS*CELL;
  alignControlsToCanvas(); // keep controls matched to canvas on every resize
}
function newGrid(){ return Array.from({length:ROWS},()=>Array(COLS).fill(0)); }

/* ===== Align footer controls to canvas (width & left edge) ===== */
function alignControlsToCanvas(){
  const canvasEl = document.getElementById('board');
  const controls = document.querySelector('footer .controls');
  const footerEl = document.querySelector('footer');
  if(!canvasEl || !controls || !footerEl) return;
  const cb = canvasEl.getBoundingClientRect();
  const fb = footerEl.getBoundingClientRect();
  controls.style.width = cb.width + 'px';
  controls.style.marginLeft = (cb.left - fb.left) + 'px';
}
/* ===== Leaderboard ===== */
const LB_KEY = 'quiztris.leaderboard.v1';

function loadLB(){
  try { return JSON.parse(localStorage.getItem(LB_KEY) || '[]'); }
  catch { return []; }
}
function saveLB(list){
  localStorage.setItem(LB_KEY, JSON.stringify(list));
}
function addLBEntry(entry){
  const list = loadLB();
  list.push(entry);
  // Sort: score desc, then level desc, then lines desc
 list.sort((a,b)=> (b.score-a.score) || (b.level-a.level) || (b.lines-a.lines) || ((b.accuracy||0)-(a.accuracy||0)));
  saveLB(list.slice(0,10)); // keep Top 10
}

function renderLB(){
  const tbody = document.querySelector('#lbTable tbody');
  const list = loadLB();
  tbody.innerHTML = '';
  list.forEach((e, i)=>{
    const tr = document.createElement('tr');
    const acc = (typeof e.accuracy === 'number') ? e.accuracy : 0;
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${escapeHtml(e.name || '—')}</td>
      <td>${escapeHtml(e.theme || '—')}</td>
      <td style="text-align:right">${acc}%</td>
      <td style="text-align:right">${e.score}</td>
      <td style="text-align:right">${e.level}</td>
      <td style="text-align:right">${e.lines}</td>
    `;
    tbody.appendChild(tr);
  });
}


function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

function openLeaderboard(finalStats){
  const pill = document.getElementById('finalStats');
  const accuracy = getQuizAccuracyPct();
  pill.textContent = `Score ${finalStats.score} • Level ${finalStats.level} • Lines ${finalStats.lines} • Acc ${accuracy}%`;

  // Prefill name from previous session if available
  const storedName = localStorage.getItem('quiztris.playerName') || '';
  const nameInput = document.getElementById('playerName');
  nameInput.value = storedName;
  setTimeout(()=> nameInput.focus(), 0);

  // Render current table
  renderLB();

  // Show overlay
  document.getElementById('leaderboard').style.display = 'grid';
  document.getElementById('saveScore').disabled = false;
  document.getElementById('saveScore').textContent = 'Save score';
}

function closeLeaderboard(){
  document.getElementById('leaderboard').style.display = 'none';
}
function getQuizAccuracyPct(){
  return quizAttempted ? Math.round((quizCorrect / quizAttempted) * 100) : 0;
}


/* Buttons */
document.addEventListener('click', (e)=>{
  if (e.target.id === 'saveScore'){
  const name = (document.getElementById('playerName').value || '').trim();
  localStorage.setItem('quiztris.playerName', name);

  const accuracy = getQuizAccuracyPct();   // <-- compute here
  addLBEntry({
    name,
    score,
    level,
    lines,
    theme,               // <-- use the current theme string
    accuracy,            // 0..100 integer
    ts: Date.now()
  });

  renderLB();
  e.target.disabled = true;
  e.target.textContent = 'Saved';
}

  if (e.target.id === 'playAgain'){
    // Show Start screen again (reuse your existing flow)
    closeLeaderboard();
    document.getElementById('start').style.display = 'grid'; // Start UI uses this overlay
  }
  if (e.target.id === 'clearLB'){
    if (confirm('Clear all leaderboard entries?')){
      saveLB([]);
      renderLB();
    }
  }
  if (e.target.id === 'closeLB'){
    closeLeaderboard();
  }
});

/* ===== Trivia loader (fetch + embedded + file-picker) ===== */
let triviaBank=[], triviaIndex=0, triviaSource='—';

async function loadTrivia(){
  // Try to load a JSON file that matches the selected theme from /themes_<lang>/
  try {
    const url = `themes_${currentLang}/${theme}.json?ts=${Date.now()}`;
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    triviaBank = await res.json();
    shuffle(triviaBank);
    triviaIndex = 0;
    triviaSource = `file:${theme}`;
    console.log('[Trivia] Loaded', theme, 'from', url, 'count=', triviaBank.length);
    $('#themeName').textContent = `${theme} (${triviaSource} @ ${currentLang})`;
    setHUDValue('themeName', theme);
    return;
  } catch (e) {
    console.warn('[Trivia] Theme file not found or blocked, trying embedded deck.', e);
  }

  // Embedded fallback
  try {
    const raw = $('#embedded-trivia')?.textContent?.trim();
    if (raw) {
      triviaBank = JSON.parse(raw);
      shuffle(triviaBank);
      triviaIndex = 0;
      triviaSource = 'embedded';
      console.log('[Trivia] Loaded embedded deck:', triviaBank.length);
      $('#themeName').textContent = `${theme} (${triviaSource} @ ${currentLang})`;
      setHUDValue('themeName', theme);
      return;
    }
  } catch (e) {
    console.warn('[Trivia] Embedded deck parse failed:', e);
  }

  // File picker fallback (works on file://)
  await openTriviaPicker();
}

// (next comes your existing)


function openTriviaPicker(){
  return new Promise(resolve=>{
    const overlay = $('#picker'); const input = $('#fileInput');
    overlay.style.display='grid';
    input.onchange = ()=>{
      const file = input.files && input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          triviaBank = JSON.parse(reader.result);
          shuffle(triviaBank); triviaIndex=0; triviaSource='picker';
          overlay.style.display='none';
          console.log('[Trivia] Loaded via file picker:', triviaBank.length);
          $('#themeName').textContent = `${theme} (${triviaSource} @ ${currentLang})`;
      setHUDValue('themeName', theme);
          resolve();
        }catch(err){
          alert('Could not parse JSON: ' + err.message);
        }
      };
      reader.readAsText(file, 'utf-8');
    };
  });
}

function getNextTrivia(){
  if(!triviaBank.length) return { type:'mcq', stem:'No trivia loaded', options:['—'], correctIndex:0 };
  const raw = triviaBank[triviaIndex];
  triviaIndex = (triviaIndex + 1) % triviaBank.length;
  if(triviaIndex === 0) shuffle(triviaBank);
  const idxs = raw.options.map((_,i)=>i); shuffle(idxs);
  const opts = idxs.map(i=>raw.options[i]);
  const correctIndex = idxs.indexOf(raw.correctIndex);
  return { type:'mcq', stem: raw.stem, options: opts, correctIndex };
}

/* ===== Piece + Physics ===== */
function spawnPiece(){
  const type=PIECES[rand(PIECES.length)];
  const shape=SHAPES[type].map(r=>r.slice());
  active={x:Math.floor(COLS/2)-Math.ceil(shape[0].length/2), y:0, type, shape};
  if (collides(grid, active)) {
  gameOver = true;
  paused = true;
  $('#status').textContent = 'Game Over';
  openLeaderboard({ score, level, lines });
}
}
function canPlaceAt(px, py, shape){
  for (let r = 0; r < shape.length; r++){
    for (let c = 0; c < shape[0].length; c++){
      if (!shape[r][c]) continue;
      const x = px + c, y = py + r;
      if (x < 0 || x >= COLS || y >= ROWS) return false;
      if (y >= 0 && grid[y][x]) return false;
    }
  }
  return true;
}

function getGhostY(piece){
  let gy = piece.y;
  while (canPlaceAt(piece.x, gy + 1, piece.shape)) gy++;
  return gy;
}

function rotate(shape){
  const h=shape.length, w=shape[0].length;
  const res = Array.from({length:w},()=>Array(h).fill(0));
  for(let y=0;y<h;y++) for(let x=0;x<w;x++) res[x][h-1-y]=shape[y][x];
  return res;
}
function collides(g, p){
  const {x,y,shape}=p;
  for(let r=0;r<shape.length;r++) for(let c=0;c<shape[r].length;c++){
    if(!shape[r][c]) continue;
    const nx=x+c, ny=y+r;
    if(nx<0||nx>=COLS||ny>=ROWS) return true;
    if(ny>=0 && g[ny][nx]) return true;
  }
  return false;
}
function merge(g,p){ const {x,y,shape,type}=p; for(let r=0;r<shape.length;r++) for(let c=0;c<shape[r].length;c++) if(shape[r][c]) g[y+r][x+c]=type; }

function drawCell(x, y, color, type){
  // base fill
  ctx.fillStyle = color;
  ctx.fillRect(x*CELL, y*CELL, CELL-1, CELL-1);

  // texture overlay if available
  if (type && textures[type]){
    ctx.globalAlpha = 0.4; // set opacity here
    ctx.drawImage(textures[type], x*CELL, y*CELL, CELL, CELL);
    ctx.globalAlpha = 1.0; // reset to default
  }
}


function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 1) Locked cells
for (let r = 0; r < ROWS; r++) {
  for (let c = 0; c < COLS; c++) {
    if (grid[r][c]) {
      const val  = grid[r][c];
      const type = (val === true) ? 'BAR' : val;
      const color = (val === true) ? colors.BAR : colors[val];
      drawCell(c, r, color, type);
    }
  }
}


  // 2) GHOST (ADD THIS)
  if (active && !gameOver){
    const gy = getGhostY(active);
    const { x, shape, type } = active;
    ctx.save();
    ctx.globalAlpha = 0.05;
    ctx.fillStyle = '#ffffff';
    for (let r=0; r<shape.length; r++){
      for (let c=0; c<shape[r].length; c++){
        if (!shape[r][c]) continue;
        ctx.fillRect((x+c)*CELL, (gy+r)*CELL, CELL-1, CELL-1);
      }
    }
    // optional subtle outline in piece color
    ctx.globalAlpha = 0.10;
    ctx.strokeStyle = colors[type] || '#ffffff';
    ctx.lineWidth = 2;
    for (let r=0; r<shape.length; r++){
      for (let c=0; c<shape[r].length; c++){
        if (!shape[r][c]) continue;
        ctx.strokeRect((x+c)*CELL+1, (gy+r)*CELL+1, CELL-3, CELL-3);
      }
    }
    ctx.restore();
  }

  // 3) Active piece
  if (active){
    const {x,y,shape,type}=active;
    for (let r=0; r<shape.length; r++)
      for (let c=0; c<shape[r].length; c++)
        if (shape[r][c]) drawCell(x+c, y+r, colors[type], type);
  }
}


function step(ts){
  if(paused||gameOver){ draw(); requestAnimationFrame(step); return; }
  if(!nextTick) nextTick = ts + dropInterval;
  if(ts >= nextTick){
    active.y++;
    if (collides(grid, active)) { active.y--; merge(grid, active); onLock(); spawnPiece(); }
    nextTick = ts + dropInterval;
  }
  draw(); requestAnimationFrame(step);
}

/* ===== Line handling (merge to bars) ===== */
function onLock(){
  const fullRows = [];
  for (let r = 0; r < ROWS; r++) {
    if (grid[r].every(v => v)) fullRows.push(r);
  }
  if (fullRows.length) {
    fullRows.forEach(r => grid[r] = Array(COLS).fill(true)); // mark as BAR
    lines += fullRows.length;
    setHUDValue('lines', lines);
    score += 100 * fullRows.length;
    setHUDValue('score', score);
    queueBars(fullRows);
  }

  if (lines >= level * 10) {
    level++;
    setHUDValue('level', level);
    updateSpeed(); // apply new speed
  }
}


/* ===== Bars queue & click highlights ===== */
const barQueue=[];
function queueBars(rows){ rows.forEach(r=>barQueue.push({row:r,pending:true,id:crypto.randomUUID()})); renderBarHighlights(); if(!quiz.active) openNextBar(); }
function renderBarHighlights(){
  const wrap=$('#barHighlights'); wrap.innerHTML='';
  barQueue.filter(b=>b.pending).forEach(b=>{
    const d=document.createElement('div'); d.className='bar-highlight';
    d.style.top=(b.row*CELL)+'px'; d.style.height=CELL+'px';
    d.style.boxShadow='inset 0 0 0 2px rgba(110,247,180,0.8)';
    d.style.pointerEvents='auto'; d.onclick=()=>openQuizForBar(b);
    wrap.appendChild(d);
  });
}
function clearAllBarHighlights(){
  const wrap = document.getElementById('barHighlights');
  if (wrap) wrap.innerHTML = '';
}


function clearBarRow(row){
  // Collapse: pull every row above down by 1
  for (let r = row; r > 0; r--) {
    grid[r] = grid[r - 1].slice();
  }
  grid[0] = Array(COLS).fill(0);
}



/* ===== Quiz system ===== */
const toast={ el:$('#toast'), title:$('#toastTitle'), stem:$('#stem'), count:$('#countdown'), uiMC:$('#ui-mc'), uiNum:$('#ui-num'), solution:$('#solution') };
const quiz={ active:false, minimized:false, bar:null, timer:null, type:null, data:null };

function showToast(){ toast.el.style.display='block'; toast.el.classList.remove('min'); $('#status').textContent='Paused'; }
function minimizeToast(){ toast.el.classList.add('min'); }
function closeToast(){ toast.el.style.display='none'; quiz.active=false; quiz.bar=null; toast.solution.value = ''; // ✅ clean up on close
}
$('#minBtn').onclick=()=>minimizeToast();
$('#closeBtn').onclick=()=>closeToast();
$('#submitNum').onclick=()=>submitNumeric();
document.addEventListener('keydown', e=>{
  if(!quiz.active) return;
  if(quiz.type==='numeric'){
    if(/^[0-9]$/.test(e.key)) toast.solution.value+=e.key;
    if(e.key==='Backspace') toast.solution.value=toast.solution.value.slice(0,-1);
    if(e.key==='Enter') submitNumeric();
  }
});
// === Math difficulty curve & builders ===
function mathCurve(level){
  // Gentle numbers at L1 since we’re allowing × and ÷ immediately
  const max       = Math.min(10 + level * 4, 99);           // operand cap
  const maxAnswer = Math.min(120 + level * 35, 999);        // final answer cap

  // Ops availability (as requested)
  const allowMul    = level >= 1;   // × from L1
  const allowDiv    = level >= 1;   // ÷ (integer only) from L1
  const allowParens = level >= 2;   // parentheses from L2

  // Frequency ramps
  // Two-step starts low (30%) and rises to 80% by late game
  const twoStepChance = Math.min(0.30 + level * 0.05, 0.80);

  // Parentheses appear only from L2: start 10% at L2, grow ~8% per level, cap at 60%
  const parenBase = Math.max(0, level - 2);                 // 0 at L1–2, then 1,2,3...
  const parenChance = allowParens ? Math.min(0.10 + parenBase * 0.08, 0.60) : 0;

  return { max, maxAnswer, allowMul, allowDiv, allowParens, twoStepChance, parenChance };
}

function ri(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function evalOp(a,op,b){ return op==='+'?a+b:op==='-'?a-b:op==='x'?a*b: b===0?NaN: a/b; }

function allowedOps(cfg){
  const ops=['+','-']; if(cfg.allowMul) ops.push('x'); if(cfg.allowDiv) ops.push('/');
  return ops;
}
function pairFor(op,max,nonNeg=true){
  let a=ri(1,max), b=ri(1,max);
  if(op==='/'){ b=ri(1,Math.max(1,Math.floor(max/2))); const k=ri(1,Math.max(1,Math.floor(max/b))); a=b*k; }
  if(op==='-'&&nonNeg&&a<b){ [a,b]=[b,a]; }
  return [a,b];
}
function oneStep(cfg){
  const ops=allowedOps(cfg);
  for(let i=0;i<120;i++){
    const op=pick(ops);
    const [a,b]=pairFor(op,cfg.max,true);
    const v=evalOp(a,op,b);
    if(!Number.isFinite(v)) continue;
    if(op==='/' && !Number.isInteger(v)) continue;
    if(Math.abs(v)>cfg.maxAnswer) continue;
    return { expr:`${a} ${op} ${b}`, value:v };
  }
  return { expr:`1 + 1`, value:2 };
}
function twoStep(cfg){
  const ops = allowedOps(cfg);
  const wantParens = cfg.allowParens && Math.random() < cfg.parenChance;

  // --- Option A: (a op1 b) op2 c  (no parentheses needed)
  function buildLeftAssoc(){
    for (let i=0;i<240;i++){
      const left = oneStep(cfg);        // (a op1 b)
      const op2 = pick(ops);
      let c;

      if (op2 === '/'){
        // pick divisor of left.value within range to keep integer division
        const divisors=[];
        for (let d=1; d<=cfg.max; d++) if (left.value % d === 0) divisors.push(d);
        if (!divisors.length) continue;
        c = pick(divisors);
      } else {
        c = ri(1, cfg.max);
        if (op2 === '-' && left.value < c) c = ri(1, left.value);
      }

      const v = evalOp(left.value, op2, c);
      if (!Number.isFinite(v) || !Number.isInteger(v)) continue;
      if (Math.abs(v) > cfg.maxAnswer) continue;

      return { expr:`${left.expr} ${op2} ${c}`, value:v };
    }
    return null;
  }

  // --- Option B: a op1 (b op2 c)  (parentheses change precedence)
  function buildRightAssoc(){
    for (let i=0;i<320;i++){
      // inner (b op2 c)
      const op2 = pick(ops);
      let b, c, innerVal;

      if (op2 === '/'){
        // choose c first, then make b = c * k to ensure integer division
        c = ri(1, Math.max(1, Math.floor(cfg.max/2)));
        const k = ri(1, Math.max(1, Math.floor(cfg.max / c)));
        b = c * k;
        innerVal = evalOp(b, '/', c);   // guaranteed integer
      } else {
        b = ri(1, cfg.max);
        c = ri(1, cfg.max);
        if (op2 === '-' && b < c) [b, c] = [c, b];
        innerVal = evalOp(b, op2, c);
        if (!Number.isFinite(innerVal)) continue;
      }
      if (!Number.isInteger(innerVal)) continue;
      if (Math.abs(innerVal) > cfg.maxAnswer) continue;

      // outer a op1 (inner)
      const op1 = pick(ops);
      let a;

      if (op1 === '/'){
        // make a a multiple of innerVal to keep a / inner integer
        const mulMax = Math.max(1, Math.floor(cfg.max / Math.max(1, innerVal)));
        const m = ri(1, mulMax);
        a = innerVal * m;
      } else {
        a = ri(1, cfg.max);
        if (op1 === '-' && a < innerVal) a = innerVal + ri(0, 5);
      }

      const v = evalOp(a, op1, innerVal);
      if (!Number.isFinite(v) || !Number.isInteger(v)) continue;
      if (Math.abs(v) > cfg.maxAnswer) continue;

      return { expr:`${a} ${op1} (${b} ${op2} ${c})`, value:v };
    }
    return null;
  }

  // pick branch
  const right = wantParens ? buildRightAssoc() : null;
  if (right) return right;

  const left = buildLeftAssoc();
  if (left) return left;

  // fallback
  return oneStep(cfg);
}

function buildMathProblem(level){
  const cfg=mathCurve(level);
  const two = Math.random() < cfg.twoStepChance;
  return two ? twoStep(cfg) : oneStep(cfg);
}

function makeMathQ(){
  // Uses global 'level' which you already update during play
  const { expr, value } = buildMathProblem(level);
  // Keep your existing UI style: use 'x' and '/' symbols like before
  return { type:'numeric', stem: `${expr} = ?`, answer: String(value) };
}



function buildUIForQuestion(q){
  if(q.type==='mcq'){
    toast.uiMC.style.display='grid'; toast.uiNum.style.display='none';
    toast.uiMC.innerHTML='';
    q.options.forEach((opt,idx)=>{
      const b=document.createElement('button'); b.textContent=opt; b.onclick=()=>submitMC(idx);
      toast.uiMC.appendChild(b);
    });
  } else {
    toast.uiMC.style.display='none'; toast.uiNum.style.display='block';
	 toast.solution.value = '';
  setTimeout(()=> toast.solution.focus(), 0);
    const pad=$('#numpad'); pad.innerHTML='';
    ['7','8','9','4','5','6','1','2','3','0','←','C'].forEach(k=>{
      const b=document.createElement('button'); b.textContent=k; b.onclick=()=>{
        if(k==='C') toast.solution.value='';
        else if(k==='←') toast.solution.value = toast.solution.value.slice(0,-1);
        else toast.solution.value += k;
      };
      pad.appendChild(b);
    });
  }
}

function pauseGame(){ paused=true; $('#status').textContent='Paused'; }
function resumeGame(){ if(!gameOver){ paused=false; $('#status').textContent='Playing'; } }

function submitNumeric(){
  const ans = toast.solution.value.trim();
  const ok = ans !== '' && Number(ans) === Number(quiz.data.answer);
  resolveAnswer(ok);
}

function submitMC(idx){ resolveAnswer(idx===quiz.data.correctIndex); }

function resolveAnswer(ok) {
  quizAttempted++;
  if (ok) quizCorrect++;

  if (ok) {
    clearBarRow(quiz.bar.row);
    quiz.bar.pending = false;
    score += 100;
    setHUDValue('score', score);

    renderBarHighlights();
    if (!barQueue.some(b => b.pending)) {
      clearAllBarHighlights();
    }

    if (quiz.timer) {
      clearInterval(quiz.timer);
      quiz.timer = null;
    }
    resumeGame();
    closeToast();
    openNextBar();

  } else {
    score = Math.max(0, score - 25);
    setHUDValue('score', score);
    toast.el.animate(
      [
        { transform: 'translateX(-50%)' },
        { transform: 'translateX(-50%) translateX(6px)' },
        { transform: 'translateX(-50%)' }
      ],
      { duration: 180 }
    );
  }
}



function openNextBar(){ const next = barQueue.find(b=>b.pending); if(next) openQuizForBar(next); }

async function openQuizForBar(bar){
  quiz.bar=bar; quiz.active=true; quiz.minimized=false;
  const q = (theme === 'math') ? makeMathQ() : getNextTrivia();
  quiz.data=q; quiz.type=q.type;

 toast.title.textContent = (theme==='math') ? t('mathTitle') : t('quizTitle');
  toast.stem.textContent = q.stem;
  buildUIForQuestion(q);
  showToast();

  // Pause on open; auto-resume when timer hits 0. Player can still answer after resume.
  pauseGame();
  let remaining = timerPauseSeconds; toast.count.textContent = remaining;
  if(quiz.timer) clearInterval(quiz.timer);
  quiz.timer = setInterval(()=>{
    remaining--; toast.count.textContent = remaining;
    if(remaining<=0){ clearInterval(quiz.timer); quiz.timer=null; resumeGame(); /* keep toast open */ }
  },1000);
}

/* ===== Controls ===== */
$('#left').onclick = ()=>{ if(paused||gameOver||!active) return; active.x--; if(collides(grid,active)) active.x++; };
$('#right').onclick= ()=>{ if(paused||gameOver||!active) return; active.x++; if(collides(grid,active)) active.x--; };
$('#rotate').onclick=()=>{ if(paused||gameOver||!active) return; const s=rotate(active.shape), old=active.shape; active.shape=s; if(collides(grid,active)) active.shape=old; };
$('#drop').onclick  =()=>{ if(paused||gameOver||!active) return; active.y++; if(collides(grid,active)){ active.y--; merge(grid,active); onLock(); spawnPiece(); } };
document.getElementById('pauseBtn').onclick = () => {
  if (paused) {
    resumeGame();
    document.getElementById('pauseBtn').textContent = 'Pause';
  } else {
    pauseGame();
    document.getElementById('pauseBtn').textContent = 'Resume';
  }
};

document.addEventListener('keydown', e=>{
  if(e.key==='ArrowLeft') $('#left').onclick();
  if(e.key==='ArrowRight') $('#right').onclick();
  if(e.key==='ArrowUp' || e.key==='x') $('#rotate').onclick();
  if(e.key==='ArrowDown' || e.key===' ') $('#drop').onclick();
});

/* ===== Start ===== */
window.addEventListener('load', ()=>{ resizeBoard(); alignControlsToCanvas(); });
window.addEventListener('resize', ()=>{ resizeBoard(); alignControlsToCanvas(); });

$('#go').onclick = async ()=>{
  theme = $('#theme').value;
  $('#themeName').textContent = theme;
  setHUDValue('themeName', theme);

  // ✅ NEW: capture language selection from start menu
  currentLang = ($('#language')?.value || 'en');

  timerPauseSeconds = Math.max(3, Math.min(20, parseInt($('#timerSec').value||'7')));
  
  const size = $('#boardSize').value.split('x');
  COLS = +size[0];
  ROWS = +size[1];
  
  resizeBoard();
  alignControlsToCanvas(); // ensure correct after sizing
  
grid = newGrid();
score = 0;
level = 1;
lines = 0;

quizCorrect = 0;       // NEW — reset quiz accuracy counters
quizAttempted = 0;     // NEW

setHUDValue('score', score);
setHUDValue('level', level);
setHUDValue('lines', lines);
setHUDValue('themeName', theme);

  
  updateSpeed();
  nextTick = 0;
  
  gameOver = false;
  paused = false;
  $('#status').textContent = 'Playing';
  $('#start').style.display = 'none';
  
  barQueue.length = 0;
  renderBarHighlights();
  
  // ✅ Language-aware trivia loader for non-math themes
  if (theme !== 'math') await loadTrivia();
  // ensure textures are ready (okay to call multiple times; they’ll be cached by the browser)
  try { await preloadTextures(); } catch(e){ console.warn('Textures failed to load', e); }
  spawnPiece();
  requestAnimationFrame(step);
};
// ===== Custom Dropdown Enhancer (minimal) =====
(function () {
  window.enhanceDropdown = function(sel){
    if (!sel || sel._enhanced) return;
    sel._enhanced = true;

    // Wrap + hide native select
    const wrap = document.createElement('div');
    wrap.className = 'select-wrap';
    sel.parentNode.insertBefore(wrap, sel);
    wrap.appendChild(sel);
    sel.classList.add('select-hidden');

    // Button (closed state)
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'select-btn';
    btn.setAttribute('aria-haspopup', 'listbox');
    btn.setAttribute('aria-expanded', 'false');

    const label = document.createElement('span');
    label.textContent = sel.options[sel.selectedIndex]?.text || 'Select';
    const caret = document.createElement('span');
    caret.className = 'select-caret';
    btn.append(label, caret);
    wrap.appendChild(btn);

    // List
    const list = document.createElement('div');
    list.className = 'select-list';
    list.setAttribute('role', 'listbox');
    wrap.appendChild(list);

    function build(){
      list.innerHTML = '';
      Array.from(sel.options).forEach((o, i) => {
        const opt = document.createElement('div');
        opt.className = 'select-option';
        opt.setAttribute('role', 'option');
        if (i === sel.selectedIndex) opt.setAttribute('aria-selected', 'true');
        opt.textContent = o.text;
        opt.addEventListener('click', () => choose(i));
        list.appendChild(opt);
      });
    }
   function open(){
  build();
  // decide up vs down based on viewport space
  const btnBox = btn.getBoundingClientRect();
  const spaceBelow = window.innerHeight - btnBox.bottom;
  const spaceAbove = btnBox.top;

  list.classList.remove('drop-up');
  // 200 is a safe heuristic; or measure list.scrollHeight after build()
  if (spaceBelow < 200 && spaceAbove > spaceBelow) {
    list.classList.add('drop-up');
  }

  list.classList.add('open');
  btn.setAttribute('aria-expanded','true');
  document.addEventListener('mousedown', outside);
  document.addEventListener('keydown', onKey);
}

    function close(){ list.classList.remove('open'); btn.setAttribute('aria-expanded','false');
      document.removeEventListener('mousedown', outside); document.removeEventListener('keydown', onKey); }
    function toggle(){ list.classList.contains('open') ? close() : open(); }
    function choose(i){
      sel.selectedIndex = i;
      label.textContent = sel.options[i].text;
      sel.dispatchEvent(new Event('change', { bubbles: true }));
      close(); btn.focus();
    }
    function outside(e){ if (!wrap.contains(e.target)) close(); }
    function onKey(e){ if (e.key === 'Escape'){ close(); btn.focus(); } if (e.key === 'Enter'){ e.preventDefault(); } }

    btn.addEventListener('click', toggle);
    sel.addEventListener('change', () => { label.textContent = sel.options[sel.selectedIndex]?.text || ''; });
  };
})();
const themeSel = document.getElementById('theme');
const langSel  = document.getElementById('language');   // or your actual id
const sizeSel  = document.getElementById('boardSize');  // or your actual id

enhanceDropdown(themeSel);
enhanceDropdown(langSel);
enhanceDropdown(sizeSel);


</script>
</body>
</html>
